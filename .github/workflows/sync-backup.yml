# Backup Branch Synchronization
#
# This workflow automatically synchronizes the 'backup' branch with the 'main' branch
# whenever changes are pushed to main. This ensures that the backup branch always
# contains the same code as the production main branch, providing a safety net
# and maintaining branch parity.
#
# The workflow performs a non-fast-forward merge to preserve commit history
# and creates a merge commit for traceability.
#
name: Sync Backup Branch

on:
  push:
    branches: [main] # Trigger only when main branch receives new commits

jobs:
  sync-backup:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository with full history to enable proper merging
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch complete history for all branches
          token: ${{ secrets.GITHUB_TOKEN }}

      # Configure Git with the GitHub Actions bot identity
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # Verify branches exist and show current state
      - name: Verify repository state
        run: |
          echo "Available branches:"
          git branch -a
          echo "Current branch: $(git branch --show-current)"
          echo "Main branch exists: $(git show-ref --verify --quiet refs/heads/main && echo 'Yes' || echo 'No')"
          echo "Backup branch exists: $(git show-ref --verify --quiet refs/heads/backup && echo 'Yes' || echo 'No')"

      # Merge main branch changes into backup branch
      - name: Sync backup branch
        run: |
          echo "Checking out backup branch..."
          git checkout backup || { echo "Failed to checkout backup branch"; exit 1; }

          echo "Current branch: $(git branch --show-current)"
          echo "Merging main into backup..."
          git merge main --no-ff -m "Auto-sync backup branch with main" || { echo "Failed to merge main into backup"; exit 1; }

          echo "Pushing changes to origin..."
          git push origin backup || { echo "Failed to push to backup branch"; exit 1; }

          echo "Backup branch successfully synchronized with main"
