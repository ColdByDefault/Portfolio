

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Blog Models
model BlogCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  color       String?  @default("#3B82F6") // Default blue color for categories
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  blogs Blog[]

  @@map("blog_categories")
}

model BlogTag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  color     String?  @default("#6B7280") // Default gray color for tags
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  blogs BlogTagRelation[]

  @@map("blog_tags")
}

model Blog {
  id            String        @id @default(cuid())
  title         String
  slug          String        @unique
  excerpt       String?       // Short description/summary
  content       String        // Main blog content (Markdown/HTML)
  featuredImage String?       // URL to featured image
  
  // Language support
  language      String        @default("en") // ISO 639-1 language code (en, de, es, fr, sv, etc.)
  
  // Metadata
  isPublished   Boolean       @default(false)
  isFeatured    Boolean       @default(false)
  isDraft       Boolean       @default(true)
  
  // SEO
  metaTitle     String?
  metaDescription String?
  
  // External Credits (if not written by you)
  credits       BlogCredit?
  
  // Stats
  readCount     Int           @default(0)
  
  // Reading time estimation (in minutes)
  readingTime   Int?
  
  // Publication dates
  publishedAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  categoryId    String?
  category      BlogCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  tags          BlogTagRelation[]

  @@map("blogs")
  @@index([slug])
  @@index([isPublished])
  @@index([publishedAt])
  @@index([categoryId])
  @@index([language])
  @@index([language, isPublished])
}

// Separate model for external credits to keep Blog model clean
model BlogCredit {
  id              String  @id @default(cuid())
  blogId          String  @unique
  originalAuthor  String  // Name of the original author
  originalSource  String? // Website, publication, etc.
  sourceUrl       String? // Link to original source
  licenseType     String? // e.g., "CC BY-SA", "MIT", "Fair Use", etc.
  creditText      String? // Custom credit text
  translatedFrom  String? // If translated, original language
  adaptedFrom     String? // If adapted/modified from original
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  blog            Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)

  @@map("blog_credits")
}

// Many-to-many relation between Blog and Tag
model BlogTagRelation {
  id     String @id @default(cuid())
  blogId String
  tagId  String

  // Relations
  blog   Blog    @relation(fields: [blogId], references: [id], onDelete: Cascade)
  tag    BlogTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([blogId, tagId])
  @@map("blog_tag_relations")
}

// Chatbot Models
model ChatSession {
  id                String          @id // session_timestamp_randomhex format
  ipAddress         String?         // Client IP (anonymized if needed)
  ipCountry         String?         // Country from IP (e.g., "US", "DE")
  ipCity            String?         // City from IP (optional, for analytics)
  userAgent         String?         // Browser/device info
  language          String?         // User's language preference
  
  // Session tracking
  startedAt         DateTime        @default(now())
  lastActivityAt    DateTime        @updatedAt
  endedAt           DateTime?       // When session explicitly ended
  isActive          Boolean         @default(true)
  
  // User consent & privacy
  consentGiven      Boolean         @default(false) // GDPR/privacy consent
  consentTimestamp  DateTime?       // When consent was given
  
  // Session metadata
  totalMessages     Int             @default(0)
  
  // Relations
  messages          ChatMessage[]

  @@map("chat_sessions")
  @@index([ipAddress])
  @@index([startedAt])
  @@index([ipCountry])
  @@index([isActive])
}

model ChatMessage {
  id                String          @id // msg_timestamp_randomhex format
  sessionId         String
  
  // Message content
  role              String          // "user" or "assistant"
  content           String          // The actual message (use @db.Text for large content)
  
  // Message metadata
  timestamp         DateTime        @default(now())
  status            String?         // "sending", "sent", "error"
  
  // Context (optional)
  pageContext       String?         // What page user was on
  errorDetails      String?         // If status is error
  
  // Relations
  session           ChatSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
  @@index([sessionId])
  @@index([timestamp])
  @@index([role])
}
